-module(proto_ws_tests).

-ifdef(TEST).
-include_lib("eunit/include/eunit.hrl").

empty_test() ->
    Data = [],
    WState = {wstate,'draft-hybi-17','proto_ws_draft-hybi-17',<<"/websocket">>,
              "http://localhost:4567","j5acgx4lcal.example.com:8081",http,
              false,
              [{"sec-websocket-extensions","x-webkit-deflate-frame"},
               {"sec-websocket-version","13"},
               {"sec-websocket-key","kkKV0lvBI+cfnfYszv8w/A=="},
               {"cache-control","no-cache"},
               {"pragma","no-cache"},
               {"origin","http://localhost:4567"},
               {"host","j5acgx4lcal.example.com:8081"},
               {"connection","Upgrade"},
               {"upgrade","websocket"}],
              true,<<>>,undefined},
    WsCallback = fun(Frame, A) ->
                         [Frame | A]
                 end,
    {[], continue, _WState2} = proto_ws:handle_data(WsCallback, [], iolist_to_binary(Data), WState).
    
    
    

parsing_test() ->
    Data = [<<129,135,54,153,130,240,20,255,237,130,85,252,160>> ,
            <<129,254,0,144,174,56,21,91,213,26,116,56,218,81,122,53,140,2,55,43,219,90,
              121,50,221,80,55,119,140,92,116,47,207,26,47,32,140,76,122,43,199,91,55,97,
              140,68,120,40,201,81,113,118,218,87,101,50,205,21,116,55,194,21,36,104,152,
              13,34,109,150,10,45,99,155,8,38,111,155,9,32,107,153,15,37,110,158,11,37,98,
              152,10,45,121,130,26,120,62,221,75,116,60,203,103,124,63,140,2,55,106,157,14,
              32,108,152,0,39,99,150,13,37,104,154,13,36,110,158,15,34,107,155,8,38,107,
              151,14,39,99,131,9,55,119,140,92,116,47,207,26,47,121,159,26,104,38>>,
            <<129,254,0,145,154,213,194,230,225,247,163,133,238,188,173,136,184,239,224,
              150,239,183,174,143,233,189,224,202,184,177,163,146,251,247,248,157,184,161,
              173,150,243,182,224,220,184,169,175,149,253,188,166,203,238,186,178,143,249,
              248,163,138,246,248,243,213,172,224,245,208,162,231,250,222,175,229,241,210,
              175,228,247,214,173,226,242,211,170,230,242,223,172,231,250,196,182,247,175,
              131,233,166,163,129,255,138,171,130,184,239,224,215,169,227,247,209,172,237,
              240,222,162,224,242,213,174,224,243,211,170,226,245,214,175,229,241,214,163,
              227,240,222,183,231,224,202,184,177,163,146,251,247,248,196,171,231,224,155,
              231>>,
            <<129,254,0,146,73,219,100,73,50,249,5,42,61,178,11,39,107,225,70,57,60,185,8,
              32,58,179,70,101,107,191,5,61,40,249,94,50,107,175,11,57,32,184,70,115,107,
              167,9,58,46,178,0,100,61,180,20,32,42,246,5,37,37,246,85,122,127,238,83,127,
              113,233,92,113,124,235,87,125,124,234,81,121,126,236,84,124,121,232,84,112,
              127,233,92,107,101,249,9,44,58,168,5,46,44,132,13,45,107,225,70,120,122,237,
              81,126,127,227,86,113,113,238,84,122,125,238,85,124,121,236,83,121,124,235,
              87,121,112,237,86,113,100,232,70,101,107,191,5,61,40,249,94,107,120,233,87,
              107,52,166,129,254,0,147,242,78,100,0,137,108,5,99,134,39,11,110,208,116,70,
              112,135,44,8,105,129,38,70,44,208,42,5,116,147,108,94,123,208,58,11,112,155,
              45,70,58,208,50,9,115,149,39,0,45,134,33,20,105,145,99,5,108,158,99,85,51,
              196,123,83,54,202,124,92,56,199,126,87,52,199,127,81,48,197,121,84,53,194,
              125,84,57,196,124,92,34,222,108,9,101,129,61,5,103,151,17,13,100,208,116,70,
              49,193,120,81,55,196,118,86,56,202,123,84,51,198,123,85,53,194,121,83,48,199,
              126,87,48,203,120,86,56,223,122,70,44,208,42,5,116,147,108,94,34,195,124,87,
              52,208,51,25>>,            
            <<129,223,7,72,113,12,124,106,16,111,115,33,30,98,37,114,83,127,114,42,2,111,
              117,33,19,105,37,100,83,104,102,60,16,46,61,106,13,97,116,47,24,104,42,60,30,
              124,110,43,92,109,107,36,92,61,52,126,68,59,49,112,67,52,63,125,65,63,51,125,
              64,57,55,127,70,60,50,120,66,60,62,126,67,52,37,100,83,106,98,60,18,100,88,
              41,29,96,37,114,5,126,114,45,12>>,
            <<136,128,95,116,222,227>>],
    WState = {wstate,'draft-hybi-17','proto_ws_draft-hybi-17',<<"/websocket">>,
              "http://localhost:4567","j5acgx4lcal.example.com:8081",http,
              false,
              [{"sec-websocket-extensions","x-webkit-deflate-frame"},
               {"sec-websocket-version","13"},
               {"sec-websocket-key","kkKV0lvBI+cfnfYszv8w/A=="},
               {"cache-control","no-cache"},
               {"pragma","no-cache"},
               {"origin","http://localhost:4567"},
               {"host","j5acgx4lcal.example.com:8081"},
               {"connection","Upgrade"},
               {"upgrade","websocket"}],
              true,<<>>,undefined},
    WsCallback = fun(Frame, A) ->
                         [Frame | A]
                 end,
    {[_Sub,
      _Pub1,
      _Pub2,
      _Pub3,
      _Pub4,
      _Force], websocket_close} = proto_ws:handle_data(WsCallback, [], iolist_to_binary(Data), WState).

-endif.
